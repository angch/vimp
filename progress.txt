# Ralph Progress Log

## Codebase Patterns
- Build: Use `tools/zig build` for consistent environment (bootstrapped via `Makefile`).
- Zig 0.15+: Use `root_module` in `b.addExecutable` instead of `root_source_file`.
- Zig 0.15+: `build.zig.zon` requires correct `.fingerprint` (use compiler suggestion).
- GTK4: `gtk_init` requires a display connection; expected failure in headless CI/Agent envs.
- Zig 0.15+: `callconv(.C)` removed; use `callconv(std.builtin.CallingConvention.c)`.
- GTK4 C-ABI: Use `gtk_css_provider_load_from_data` for CSS loading (safer than `load_from_string` across versions).
- GTK4 Callbacks: Ensure function signatures strictly match C headers (e.g. `[*c]` or `?*` vs `*`). Zig 0.15+ is strict about optional vs non-optional pointers in callbacks.
- Dependencies: Use `tools/setup_libs.sh` to download and extract GEGL/Babl to `./libs` for local development. `build.zig` is configured to look there.
- Zig 0.15+: Use `pub const c = @cImport(...)` instead of `pub usingnamespace` for C-imports.
- Runtime: GEGL_PATH/BABL_PATH must be set for plugins. Use `run_cmd.setEnvironmentVariable` in `build.zig`.
- GEGL Painting: Use `GeglBuffer` + `gegl:buffer-source` + `gegl:over` for mutable paint layers.
- GEGL Compositing: Use `gegl_node_connect(over_node, "aux", ...)` to connect auxiliary inputs like paint layers.
- GTK4 Incompatibility: GIMP headers (GTK3-based) clash with GTK4 headers. Mock removed types (e.g. `GtkMenu`, `GdkEventKey`) when verifying offsets.
- Zig 0.15+: `addTest` requires `root_module`. Use `test_module.addImport` to include project-internal modules.

## 2026-01-30 T13:35 - US-001
- Implemented Zig structs for `GimpTool`, `GimpDrawTool`, `GimpColorTool`, `GimpPaintTool`, `GimpBrushTool`.
- Created `src/gimp/mock_gtk3.h` to facilitate offset verification against GIMP headers.
- Created `src/test_hierarchy.zig` to verify memory layout matches C.
- Files changed: `src/gimp/*.zig`, `build.zig`, `src/test_hierarchy.zig`.
- **Learnings for future iterations:**
  - `ref/gimp` headers expect GTK3; `vimp` uses GTK4. Direct inclusion fails without mocks.
  - Zig test files inside subdirectories (`src/gimp/test.zig`) treat that dir as root, breaking `../c.zig` imports. Use `src/test.zig` or explicit module configuration.
---

